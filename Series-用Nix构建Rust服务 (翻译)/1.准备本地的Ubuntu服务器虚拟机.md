> 本系列翻译自fasterthanlime(Amos Wenger)的系列文章《Building a Rust service with Nix》（[原文链接](https://fasterthanli.me/series/building-a-rust-service-with-nix))
>
> 这一系列文章囊括了对虚拟机、编译环境配置、Docker等在Nix服务开发中不可或缺的各种元素的介绍，是难得的一套全面、完整的学习资料，对不熟悉Linux的学习者非常友好。系列文章假定你已了解Rust的基本语法。
>
> 如果系列文章对你有帮助，请考虑支持原作者：[How can you support me?](https://fasterthanli.me/donate)
>


我时常会就如何舒适地构建Rust服务提出一些零碎的建议。但是，要了解一切是如何组合在一起的可能很难，尤其是在生产环境中部署网络服务时。

所以，让我们从最基本的地方（准备一个Linux虚拟机）开始，向着这个目标进军：一个用Nix构建的生产级Rust Web服务。

---

用Nix来构建Rust应用的第一步，是先构建应用而 _不使用_ Nix，这样当我们最终用上Nix时，我们才能感受到差异。

有很多方法可以做到这一点：每个人都有他们最喜欢的代码编辑器、基础Linux发行版（甚至还有[NixOS](https://nixos.org/)发行版，我就不一一介绍了）。有些人喜欢先在macOS上开发，_然后_再为Linux编译。

你们的想法都是对的，但是对这个系列来说，我们将非常具体地介绍我在使用Nix前 _曾经_ 的做法，以及我现在年过30、成为“Nix人”之后的做法，并且，我们将会评价这两种方法的优缺点。

哪怕你还没有准备好放弃NeoVim，或者你还不想折腾Linux虚拟机，这篇文章在很大程度上也会对你有用——你只需要再做点额外的工作，让它在你最喜欢的设置下运行就好了。

那么，就让我们开始吧！

## 为这一系列文章选套工具

我是在Windows 11上做完这一切的（震惊吧！佩服吧！），并且我将用[VirtualBox](https://www.virtualbox.org/)来搭建一个从头开始的[Ubuntu 22.04.1](https://ubuntu.com/)虚拟机。然后，我们将通过[VSCode](https://code.visualstudio.com/)的[Remote - SSH](https://code.visualstudio.com/docs/remote/ssh)功能来访问虚拟机。

> 
> **酷酷熊的棒提示**
>
> 你可以用一个别的虚拟机管理器。在Windows上已经内置了Hyper-V（这是[WSL2](https://ubuntu.com/tutorials/install-ubuntu-on-wsl2-on-windows-11-with-gui-support#1-overview)所需要的）。事实上，你可以全都只使用WSL2！
>
> 你也可以使用[VMWare Workstation Player](https://www.vmware.com/products/workstation-player.html)。或者，你可以使用“裸金属”安装的Linux，只要你不讨厌/早已在使用双启动。
>
> 关于使用虚拟机，另一个动人的理由是它可以轻松地将不同的项目区分开：“日常工作”和副业的项目、做咨询时的不同客户、等等。如果它们都被完全独立地安装，那就完全没有混淆的风险了。
>
> 也可以使用容器而不是虚拟机，但因为作为这系列文章的一部分，我们需要在虚拟机里运行容器；而[在容器里运行容器（Docker in docker）](https://shisho.dev/blog/posts/docker-in-docker/)很麻烦，因此我们就别这样做了。
>
> Ubuntu不一定是日常发行版里的最佳选择。[Fedora](https://getfedora.org/)惊人地好用，之前提到过的NixOS也是。
>

总之：这系列文章是为你在家里一步步跟着做来设计的，所以你要知道，你加的调料越多，你要做的事情就越多。你可以先按部就班，以后再放飞自我，这会很棒。但你是你自己，你有决定权和自己想做的事情。

免责声明说完了，我们开始吧。

> 
> **酷酷熊的棒提示**
>
> 如果不想从零开始自己搭一个虚拟机，你可以从类似[osboxes](https://www.osboxes.org/ubuntu/)的网站下载预制的镜像。
>
> 当然，如果你信任它们的话。
>
> 你仍然需要看看我们将在这节里谈到的各种设置，尤其是CPU使用和端口转发方面的。
>

我们可以从[Ubuntu官网](https://ubuntu.com/download/server)上下载Ubuntu Server 22.04.1 LTS的安装镜像：对我来说大小是1.4GB。

![在Google Chrome内下载Ubuntu ISO](https://s.c.accr.cc/picgo/1715088642-c8cbd1.jpeg)

## 创建一个能使用所有核的虚拟机

在下载的时候，让我们在VirtualBox里建一个新的虚拟机：我的主虚拟机叫“sonic”，所以我将会把这个新的叫做“mlies”，选个有足够大小的磁盘，将类型设为“Linux”，版本设为“Ubuntu（64位）”。

![VirtualBox截图，创建新虚拟机，命名为miles](https://s.c.accr.cc/picgo/1715092015-727008.png)

我相当确定这些字段 _主要_ 是在设置图标，不过它们也可能会影响配置界面里VirtualBox的建议设置。

在配置助手的下一步里，VirtualBox询问我们虚拟机的最大内存容量。你需要给主机的操作系统留点空间。对我来说，我有128GiB，所以我不必担心这些事情，直接给它16GiB。

![在配置助手里选择16GiB的RAM](https://s.c.accr.cc/picgo/1715092438-e891e6.png)

然后它该创建一个虚拟硬盘：

![VirtualBox对话框，告诉我们如果愿意可以添加一个虚拟硬盘。“现在创建一个硬盘”被选中了，这正是我们要的](https://s.c.accr.cc/picgo/1715092576-900e92.png)

我们可以直接使用默认类型：

![VDI镜像类型被默认选中](https://s.c.accr.cc/picgo/1715092673-b7b56e.png)

默认的分配策略（动态）：

![我们可以选择（默认的）动态分配和固定大小](https://s.c.accr.cc/picgo/1715092752-c5dc37.png)

然后它告诉我们磁盘文件会放在哪里，并且我们可以为它选择一个最大大小。我将选择100GiB，反正是动态分配的：

![配置助手的文件位置和大小部分，有一个拖动条和输入框来让我们选择最大大小](https://s.c.accr.cc/picgo/1715092856-08f8e1.png)

我们的新虚拟机现在已经入列并可以启动了，但在我们启动之前，先看看设置吧：

![VirtualBox的主界面，显示了我的主虚拟机，sonic，和我刚刚创建的那一个](https://s.c.accr.cc/picgo/1715092973-5a7410.png)

例如，虚拟机默认被限制为1个CPU核心。我有16个可用的核，让我们允许虚拟机使用所有核心：

![在设置—系统—处理器下，处理器滑块被移到了16](https://s.c.accr.cc/picgo/1715093097-beed2c.png)

> 
> **酷酷熊的棒提示**
>
> 通常你会想给主机留至少一个核心，以保证你的“客人”不会意外地让整台主机都无法响应。但，就像小朋友们说的，你一生只活一次（you only live once）。
>

## 设置端口转发

因为我们将要通过SSH来连接虚拟机，所以我们也需要关心一下网络。这里有许多可供选择的方案，但我们可以继续使用默认的NAT（它的优点是不会打断你的IPv6连接，如果你的ISP提供的话）……

![仍然是虚拟机设置，网络—适配器1，它被启用并连接到NAT上，一个鼠标指针正不详地放置在“端口转发”按钮上](https://s.c.accr.cc/picgo/1715093553-b8ec1f.png)

……我们将会简单地设置一个端口转发规则：主机上的2223端口（2222已经给我的主虚拟机了）将会转发到我们的`miles`虚拟机的22端口上：

![前面提到过的端口转发规则：名字是SSH，协议是TCP，主IP和客IP为空，主端口是2223，客端口为22。希望这能工作。](https://s.c.accr.cc/picgo/1715093724-197d74.png)

## 确保你有一个GitHub账号

因为我们会首先在Ubuntu上不使用nix来写一个Rust服务，然后再用nix重新写一遍，所以我们需要把代码放在某个另外的地方。这也就是说，当我们准备好开始使用nix时，我们将可以仅仅克隆我们的仓库并编译它。

尽管有很多可以用来存储Git仓库的服务，在这个系列里，我们将会使用[GitHub](https://github.com/)——确保你已经在那里有一个账号了，并且按照他们的指导[通过SSH连接到GitHub](https://docs.github.com/en/authentication/connecting-to-github-with-ssh)。


